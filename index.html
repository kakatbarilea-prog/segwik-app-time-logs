<!DOCTYPE html> 
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
<title>Time Logs</title>
<style>
  :root{
    --bg:#f6f8fb;
    --card:#ffffff;
    --ink:#1f2937;
    --muted:#7b8794;
    --line:#e7edf5;
    --accent:#2c7dbf;         /* matches screenshot-ish blue */
    --tab:#8b96a8;
    --tabActive:#2c7dbf;
    --phone-w:430px;
    --phone-h:800px;
    --footer-h:74px;
    --status-h:44px;
    --head-h:56px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:var(--bg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;color:var(--ink)}
  .wrap{display:flex;align-items:center;justify-content:center;min-height:100%;padding:18px}

  /* phone shell */
  .phone{
    width:var(--phone-w);
    height:var(--phone-h);
    background:#fff;
    border-radius:34px;
    box-shadow:0 20px 60px rgba(0,0,0,.12),0 8px 16px rgba(0,0,0,.08);
    border:8px solid #111;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    position:relative;
  }
   .notch{
    position:absolute;top:8px;left:50%;transform:translateX(-50%);
    width:180px;height:30px;background:#111;border-radius:20px 20px 28px 28px;z-index:9;
    display:none; /* hide notch so "Time Logs" heading is fully visible */
  }

  /* top header bar like screenshot */
  .topbar{
    height:var(--head-h);
    display:flex;
    align-items:center;
    justify-content:center;
    border-bottom:1px solid var(--line);
    background:#fff;
    position:sticky;top:0;z-index:5;
  }
  .topbar .title{
    font-weight:700;
    color:var(--accent);
    font-size:20px;
    letter-spacing:.2px;
  }
  .topbar .plus{
    position:absolute;
    right:14px;
    width:28px;height:28px;
    display:grid;place-items:center;
    border-radius:999px;
    border:2px solid var(--accent);
    color:var(--accent);
    background:#fff;
    cursor:pointer;
  }
  .topbar .plus svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  /* header back arrow (for views/add screens) */
  .topbar .backBtn{
    position:absolute;
    left:10px;
    width:36px;height:36px;
    border-radius:10px;
    border:1px solid var(--line);
    display:grid;place-items:center;
    cursor:pointer;
    background:#fff;
    color:#111;
  }
  .topbar .backBtn svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  /* search row */
  .searchRow{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 12px;
    background:#fff;
  }
  .search{
    flex:1;
    display:flex;
    align-items:center;
    gap:8px;
    padding:10px 12px;
    border:2px solid #111;
    border-radius:10px;
    background:#fff;
  }
  .search svg{width:18px;height:18px;stroke:#111;fill:none;stroke-width:2}
  .search input{
    border:0;outline:none;width:100%;
    font-size:14px;
  }
  .hamburger{
    width:42px;height:42px;
    border-radius:10px;
    display:grid;place-items:center;
    cursor:pointer;
    background:#fff;
  }
  .hamburger svg{width:22px;height:22px;stroke:#111;fill:none;stroke-width:2;stroke-linecap:round}

  /* list */
  .content{
    flex:1;
    overflow:auto;
    background:var(--bg);
    padding:10px 10px calc(var(--footer-h) + 10px);

    /* hide scrollbar but keep scroll */
    scrollbar-width: none;           /* Firefox */
    -ms-overflow-style: none;        /* IE/Edge legacy */
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }
  .content::-webkit-scrollbar{
    width:0;
    height:0;
    display:none;                    /* Chrome/Safari */
  }

  .row{
    background:#fff;
    border:1px solid var(--line);
    border-radius:14px;
    padding:12px;
    display:grid;
    grid-template-columns:56px 1fr 18px;
    gap:12px;
    align-items:center;
    margin:10px 0;
    box-shadow:0 6px 16px rgba(15,45,86,.06);
    cursor:pointer;
  }

  /* UPDATED: Attorney headshot avatars */
  .avatar{
    width:44px;height:44px;border-radius:999px;
    border:2px solid var(--accent);
    display:grid;place-items:center;
    background:#fff;
    overflow:hidden;
  }
  .avatar img{
    width:100%;
    height:100%;
    object-fit:cover;
    display:block;
  }

  .meta{min-width:0}
  .line1{
    font-size:16px;
    font-weight:500;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .line1 .t{
    font-weight:500;
    color:#111;
  }
  .line1 .dot{opacity:.45;padding:0 6px}
  .line2{
    margin-top:2px;
    font-size:13px;
    color:#9aa3af;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .chev{
    justify-self:end;
    color:#111;
    opacity:.8;
  }
  .chev svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  /* bottom tab bar */
  .tabs{
    height:var(--footer-h);
    border-top:1px solid var(--line);
    background:#fff;
    display:grid;
    grid-template-columns:repeat(5,1fr);
    padding:6px 6px 8px;
    position:absolute;
    bottom:0;
    left:0; right:0;
  }
  .tab{
    display:flex;
    flex-direction:column;
    align-items:center;
    justify-content:center;
    gap:4px;
    color:var(--tab);
    font-size:11px;
  }
  .tab svg{width:20px;height:20px;stroke:currentColor;fill:none;stroke-width:2}
  .tab.active{color:var(--tabActive);font-weight:700}

  .tabs.hidden{display:none;}

  /* ------- Screen stack ------- */
  .screens{position:relative;flex:1;overflow:hidden;background:var(--bg)}
  .screen{
    position:absolute;inset:0;
    display:flex;flex-direction:column;
    transform:translateX(0);
    opacity:1;
    transition:transform .35s ease, opacity .35s ease;
    will-change:transform, opacity;
  }
  .screen.hidden{opacity:0;pointer-events:none}
  .screen.off-right{transform:translateX(100%);opacity:0;pointer-events:none}
  .screen.off-left{transform:translateX(-12%);opacity:0;pointer-events:none}

  /* details screen */
  .detailsHead{
    background:#fff;
    border-bottom:1px solid var(--line);
    padding:10px 12px;
    display:flex;align-items:center;gap:10px;
    position:relative;
  }
  .back{
    width:36px;height:36px;border-radius:10px;
    border:1px solid var(--line);
    display:grid;place-items:center;
    cursor:pointer;
    background:#fff;
    z-index:2;
  }
  .back svg{width:18px;height:18px;stroke:#111;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  .detailsTitleCentered{
    position:absolute;
    left:50%;
    transform:translateX(-50%);
    font-weight:700;
    color:var(--accent);
    width:70%;
    text-align:center;
    pointer-events:none;
  }

  .detailsBody{
    padding:12px;
    overflow:auto;
    flex:1;
    padding-bottom:calc(var(--footer-h) + 16px);

    scrollbar-width: none;
    -ms-overflow-style: none;
    overscroll-behavior: contain;
    -webkit-overflow-scrolling: touch;
  }
  .detailsBody::-webkit-scrollbar{width:0;height:0;display:none;}

  /* Company Details block */
  .companyCard{
    background:#fff;
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:0 8px 22px rgba(15,45,86,.08);
    padding:14px;
    display:grid;
    grid-template-columns:1fr 44px;
    gap:12px;
    align-items:center;
  }

  .companyMeta{min-width:0}
  .companyName{
    font-weight:600;
    color:#111;
    font-size:16px;
    line-height:1.15;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .companySub{
    margin-top:6px;
    font-size:13px;
    color:#5b6776;
    line-height:1.35;
  }
  .companySub .k{color:#8a94a6;font-weight:600}

  .companyViewBtn{
    display:inline-flex;
    align-items:center;
    justify-content:flex-end;
    gap:6px;
    background:transparent;
    border:0;
    padding:0;
    cursor:pointer;
    color:var(--accent);
    font-size:13px;
    font-weight:600;
    line-height:1;
    white-space:nowrap;
  }

  /* action icons row */
  .actionRow{
    margin:10px 0 12px;
    display:flex;
    align-items:center;
    justify-content:center;
    gap:26px;
  }
  .actionBtn{
    width:42px;height:42px;border-radius:999px;
    border:2px solid rgba(44,125,191,.35);
    display:grid;place-items:center;
    color:var(--accent);
    background:#fff;
    cursor:pointer;
    box-shadow:0 6px 16px rgba(15,45,86,.06);
  }
  .actionBtn svg{width:22px;height:22px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  /* detail field grid */
  .fieldCard{
    background:#fff;
    border:1px solid var(--line);
    border-radius:18px;
    padding:14px;
    box-shadow:0 8px 22px rgba(15,45,86,.08);
    margin:12px 0;
  }
  .fieldTitle{
    font-weight:600;
    color:#111;
    font-size:14px;
    display:flex;
    align-items:center;
    gap:10px;
    margin-bottom:10px;
  }
  .fieldTitle .dot{
    width:9px;height:9px;border-radius:999px;background:var(--accent);
    opacity:.85;
  }
  .kvGrid{
    display:grid;
    grid-template-columns:1fr;
    gap:8px;
  }
  .kv{
    display:grid;
    grid-template-columns:120px 1fr;
    gap:12px;
    align-items:start;
    font-size:13px;
    padding:6px 0;
    cursor:pointer;
  }
  .kv:active{opacity:.65}
  .k{
    color:#8a94a6;
    font-weight:400;
    letter-spacing:.2px;
    text-transform:none;
  }
  .v{
    color:#111;
    font-weight:400;
    line-height:1.35;
    word-break:break-word;
  }
  .mutedV{color:#5b6776;font-weight:500}

  /* views list (pills) */
  .pill{
    background:#fff;
    border:1px solid var(--line);
    border-radius:16px;
    padding:18px 12px;
    margin:14px 0;
    text-align:center;
    font-weight:600;
    color:#111;
    box-shadow:0 8px 22px rgba(15,45,86,.08);
    cursor:pointer;
  }

  /* ---------- Add Time Log form ---------- */
  .formCard{
    background:#fff;
    border:1px solid var(--line);
    border-radius:18px;
    box-shadow:0 8px 22px rgba(15,45,86,.08);
    padding:14px;
    margin:12px 0;
  }

  /* =========================
     NEW: "Optional" visual language (without saying optional)
     - muted until engaged
     ========================= */
  .formCard.softDisabled{
    opacity:.65;
    filter:saturate(.7);
    box-shadow:none;
    border-style:dashed;
  }
  .formCard.softDisabled .sectionHead{
    color:#6b7280;
  }
  .formCard.softDisabled select,
  .formCard.softDisabled input,
  .formCard.softDisabled textarea{
    background:#f8fafc;
    cursor:pointer;
  }

  /* subtle “tap to engage” glow */
  .formCard.engaged{
    opacity:1;
    filter:none;
    box-shadow:0 10px 24px rgba(15,45,86,.10);
    border-style:solid;
  }

  .formLabel{
    font-size:12px;
    font-weight:500;
    color:#64748b;
    margin:12px 0 6px;
  }

  .formInput, .formSelect, .formTextarea{
    width:100%;
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px 12px;
    font-size:14px;
    background:#fff;
    outline:none;
  }

  .formTextarea{
    min-height:90px;
    resize:none;
  }

  .formRow2{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
  }

  .sectionHead{
    font-weight:500;
    color:#111;
    font-size:14px;
    margin:6px 0 10px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .sectionHead .dot{
    width:9px;height:9px;border-radius:999px;background:var(--accent);opacity:.85;
  }

  .pillRow{
    display:flex;
    flex-wrap:wrap;
    gap:10px;
    margin-top:6px;
  }

  .choicePill{
    border:1px solid var(--line);
    background:#fff;
    border-radius:999px;
    padding:10px 12px;
    font-size:13px;
    cursor:pointer;
    user-select:none;
    display:inline-flex;
    align-items:center;
    gap:8px;
    box-shadow:0 6px 14px rgba(15,45,86,.05);
  }
  .choicePill:active{opacity:.7}
  .choicePill.active{
    border-color:rgba(44,125,191,.6);
    box-shadow:0 10px 22px rgba(44,125,191,.14);
  }
  .choicePill .miniTag{
    font-size:11px;
    color:#6b7280;
    font-weight:600;
  }

  .choicePill.otherPill{
    border-color:#cbd5e1;
    background:#f1f5f9;
    color:#0f172a;
  }

  .choicePill.billingCredits{
    border-color:rgba(44,125,191,.35);
    background:rgba(44,125,191,.08);
    color:#0b1b2b;
  }
  .choicePill.billingBillable{
    border-color:rgba(34,197,94,.35);
    background:rgba(34,197,94,.10);
    color:#0b2b16;
  }
  .choicePill.billingCredits.active{
    border-color:rgba(44,125,191,.75);
    box-shadow:0 10px 22px rgba(44,125,191,.16);
  }
  .choicePill.billingBillable.active{
    border-color:rgba(34,197,94,.75);
    box-shadow:0 10px 22px rgba(34,197,94,.16);
  }

  .userChip{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px;
    border:1px solid var(--line);
    border-radius:16px;
    background:#fff;
  }
  .userLeft{
    display:flex;
    align-items:center;
    gap:12px;
    min-width:0;
  }
  .userAvatar{
    width:42px;height:42px;border-radius:999px;
    border:2px solid var(--accent);
    overflow:hidden;
    background:#fff;
    display:grid;place-items:center;
    flex:0 0 auto;
  }
  .userAvatar img{width:100%;height:100%;object-fit:cover;display:block}
  .userName{
    font-weight:600;
    color:#111;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .userEditBtn{
    border:1px solid var(--line);
    border-radius:999px;
    padding:8px 10px;
    font-size:12px;
    color:var(--accent);
    cursor:pointer;
    background:#fff;
    font-weight:700;
    white-space:nowrap;
  }

  .primaryBtn{
    width:100%;
    padding:14px 14px;
    border-radius:14px;
    border:0;
    background:var(--accent);
    color:#fff;
    font-weight:700;
    font-size:15px;
    cursor:pointer;
    box-shadow:0 10px 22px rgba(44,125,191,.22);
    margin-top:14px;
  }
  .primaryBtn:active{opacity:.8}

  /* =========================
     NEW: Stepper UI for Add Log
     ========================= */
  .stepWrap{
    flex:1;
    overflow:auto;
    background:var(--bg);
    padding:10px 10px calc(var(--footer-h) + 10px);
    scrollbar-width:none;
    -ms-overflow-style:none;
    overscroll-behavior:contain;
    -webkit-overflow-scrolling:touch;
  }
  .stepWrap::-webkit-scrollbar{width:0;height:0;display:none;}

  .step{
    display:none;
    min-height:calc(var(--phone-h) - var(--head-h) - 40px);
  }
  .step.active{display:block;}

  .stepCentered{
    display:flex;
    flex-direction:column;
    justify-content:center;
    min-height:calc(var(--phone-h) - var(--head-h) - 140px);
  }

  /* NEW: when you want top-aligned (not centered) */
  .stepTopAligned{
    justify-content:flex-start;
    padding-top:0;
  }

  .stepActions{
    position:sticky;
    bottom:0;
    background:linear-gradient(to top, rgba(246,248,251,1), rgba(246,248,251,.92), rgba(246,248,251,0));
    padding:12px 0 6px;
    margin-top:10px;
  }

  .secondaryBtn{
    width:100%;
    padding:13px 14px;
    border-radius:14px;
    border:1px solid var(--line);
    background:#fff;
    color:#111;
    font-weight:700;
    font-size:15px;
    cursor:pointer;
    box-shadow:0 8px 18px rgba(15,45,86,.06);
    margin-top:10px;
  }
  .secondaryBtn:active{opacity:.85}

  .microHint{
    font-size:12px;
    color:#6b7280;
    text-align:center;
    margin-top:8px;
    line-height:1.35;
  }

  .miniStepTitle{
    font-weight:700;
    font-size:14px;
    color:#111;
    margin:6px 0 10px;
    display:flex;
    align-items:center;
    gap:10px;
  }
  .miniStepTitle .dot{
    width:9px;height:9px;border-radius:999px;background:var(--accent);opacity:.85;
  }

  /* attachments strip (optional end) */
  .attachStrip{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    border:1px dashed rgba(44,125,191,.35);
    background:rgba(44,125,191,.06);
    border-radius:16px;
    padding:12px 12px;
    cursor:pointer;
  }
  .attachStrip .left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }
  .paperclip{
    width:34px;height:34px;border-radius:12px;
    border:1px solid rgba(44,125,191,.25);
    display:grid;place-items:center;
    color:var(--accent);
    background:#fff;
    flex:0 0 auto;
  }
  .paperclip svg{width:18px;height:18px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
  .attachText{min-width:0}
  .attachTitle{font-weight:700;color:#0b1b2b;font-size:13px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .attachSub{margin-top:2px;font-size:12px;color:#5b6776;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

  /* NEW: Attachments list + loader */
  .fileInputHidden{display:none;}
  .attachList{
    margin-top:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }
  .fileRow{
    border:1px solid var(--line);
    border-radius:16px;
    background:#fff;
    padding:10px 10px;
    box-shadow:0 6px 14px rgba(15,45,86,.05);
  }
  .fileTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .fileMeta{
    min-width:0;
  }
  .fileName{
    font-weight:700;
    font-size:13px;
    color:#111;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .fileSub{
    margin-top:2px;
    font-size:12px;
    color:#6b7280;
  }
  .fileRight{
    display:flex;
    align-items:center;
    gap:8px;
    flex:0 0 auto;
  }
  .filePct{
    font-size:12px;
    font-weight:800;
    color:#0b1b2b;
  }
  .fileRemove{
    width:28px;height:28px;
    border-radius:10px;
    border:1px solid var(--line);
    display:grid;place-items:center;
    cursor:pointer;
    background:#fff;
    color:#111;
  }
  .fileRemove svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}

  .progTrack{
    margin-top:8px;
    width:100%;
    height:8px;
    border-radius:999px;
    background:#eef2f7;
    overflow:hidden;
  }
  .progBar{
    height:100%;
    width:0%;
    background:rgba(44,125,191,.9);
    border-radius:999px;
    transition:width .25s ease;
  }

  /* =========================
     NEW: Details Attachments (always visible + editable)
     ========================= */
  .detailAttachStrip{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    border:1px dashed rgba(44,125,191,.35);
    background:rgba(44,125,191,.06);
    border-radius:16px;
    padding:12px 12px;
    cursor:pointer;
  }
  .detailAttachStrip .left{
    display:flex;
    align-items:center;
    gap:10px;
    min-width:0;
  }

  .detailAttachList{
    margin-top:12px;
    display:flex;
    flex-direction:column;
    gap:10px;
  }

  .detailFileRow{
    border:1px solid var(--line);
    border-radius:16px;
    background:#fff;
    padding:10px 10px;
    box-shadow:0 6px 14px rgba(15,45,86,.05);
  }
  .detailFileTop{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
  }
  .detailFileMeta{min-width:0;}
  .detailFileName{
    font-weight:700;
    font-size:13px;
    color:#111;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }
  .detailFileSub{
    margin-top:2px;
    font-size:12px;
    color:#6b7280;
  }
  .detailFileRight{
    display:flex;
    align-items:center;
    gap:8px;
    flex:0 0 auto;
  }
  .detailFileRemove{
    width:28px;height:28px;
    border-radius:10px;
    border:1px solid var(--line);
    display:grid;place-items:center;
    cursor:pointer;
    background:#fff;
    color:#111;
  }
  .detailFileRemove svg{width:16px;height:16px;stroke:currentColor;fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
  /* =========================
     NEW: Billing Split UI (credits + billable)
     ========================= */
  .tinyNote{
    font-size:12px;
    color:#6b7280;
    line-height:1.35;
    margin-top:8px;
  }

  .splitRow{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    padding:10px 12px;
    border:1px solid var(--line);
    border-radius:14px;
    background:#fff;
    margin-top:10px;
  }
  .splitRow .left{
    min-width:0;
  }
  .splitRow .label{
    font-weight:700;
    font-size:13px;
    color:#111;
    line-height:1.15;
  }
  .splitRow .sub{
    margin-top:4px;
    font-size:12px;
    color:#6b7280;
    white-space:nowrap;
    overflow:hidden;
    text-overflow:ellipsis;
  }

  .splitRow .right{
    flex:0 0 auto;
    display:flex;
    align-items:center;
    gap:10px;
  }

  .miniInput{
    width:92px;
    padding:10px 10px;
    border-radius:12px;
    border:1px solid var(--line);
    font-size:13px;
    font-weight:700;
    text-align:right;
    outline:none;
    background:#fff;
  }

  .miniToggle{
    width:44px;height:26px;border-radius:999px;
    background:#e5e7eb;
    position:relative;
    cursor:pointer;
    flex:0 0 auto;
    border:1px solid #d1d5db;
  }
  .miniToggle::after{
    content:"";
    position:absolute;top:50%;left:3px;transform:translateY(-50%);
    width:20px;height:20px;border-radius:999px;
    background:#fff;
    box-shadow:0 4px 10px rgba(0,0,0,.12);
    transition:left .18s ease;
  }
  .miniToggle.on{
    background:rgba(44,125,191,.35);
    border-color:rgba(44,125,191,.35);
  }
  .miniToggle.on::after{left:21px;}

  .billSummary{
    margin-top:12px;
    border:1px solid var(--line);
    border-radius:16px;
    background:#fff;
    padding:12px;
    box-shadow:0 6px 14px rgba(15,45,86,.05);
  }
  .billSummaryTitle{
    font-weight:800;
    font-size:13px;
    color:#111;
    margin-bottom:10px;
  }
  .billSummaryGrid{
    display:grid;
    grid-template-columns:1fr auto;
    gap:8px 10px;
    font-size:13px;
  }
  .billSummaryGrid .k{color:#6b7280;font-weight:700;}
  .billSummaryGrid .v{color:#111;font-weight:800;}
  .billError{
    display:none;
    margin-top:10px;
    border:1px solid rgba(239,68,68,.35);
    background:rgba(239,68,68,.08);
    color:#7f1d1d;
    border-radius:14px;
    padding:10px 12px;
    font-size:12px;
    font-weight:800;
    line-height:1.35;
  }
  .billError.show{display:block;}

</style>
</head>

<body>
<div class="wrap">
  <div class="phone">
    <div class="notch"></div>

    <!-- Screen stack -->
    <div class="screens" id="screens">

      <!-- Screen 1: Time Logs list -->
      <div class="screen" id="screen-list">
        <div class="topbar">
          <div class="title">Time Logs</div>
          <div class="plus" onclick="openAddTimeLog()">
            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          </div>
        </div>

        <div class="searchRow">
          <div class="search">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
            <input id="q" placeholder="Search" />
          </div>
          <div class="hamburger" onclick="openViews()">
            <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
          </div>
        </div>

        <div class="content">
          <div id="list"></div>
        </div>
      </div>

      <!-- Screen 2: Time Log details -->
      <div class="screen off-right hidden" id="screen-details" aria-hidden="true">
        <div class="detailsHead">
          <div class="back" onclick="navBack()">
            <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          </div>
          <div class="detailsTitleCentered">Time Log Details</div>
        </div>

        <div class="detailsBody" id="detailsBody"></div>
      </div>

      <!-- Screen 3: Time Log Views -->
      <div class="screen off-right hidden" id="screen-views" aria-hidden="true">
        <div class="topbar">
          <div class="backBtn" onclick="closeViews()">
            <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          </div>
          <div class="title">Time Log Views</div>
          <div class="plus" onclick="demoViewsPlus()">
            <svg viewBox="0 0 24 24"><path d="M12 5v14M5 12h14"/></svg>
          </div>
        </div>

        <div class="searchRow">
          <div class="search">
            <svg viewBox="0 0 24 24"><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></svg>
            <input id="viewSearch" placeholder="Search" />
          </div>
        </div>

        <div class="content" style="padding-top:4px;">
          <div id="viewsList"></div>
        </div>
      </div>

      <!-- Screen 4: Add Time Log -->
      <div class="screen off-right hidden" id="screen-add" aria-hidden="true">
        <div class="topbar">
          <!-- UPDATED: back button now respects step history -->
          <div class="backBtn" onclick="addBack()">
            <svg viewBox="0 0 24 24"><path d="M15 18l-6-6 6-6"/></svg>
          </div>
          <div class="title">Add Time Log</div>
        </div>

        <!-- NEW stepper container (replaces single long scroll) -->
        <div class="stepWrap" id="addStepper">

          <!-- STEP 1: Duration + Logged by + When did you do this -->
          <div class="step active" id="step-1">
            <div class="formCard">
              <div class="sectionHead"><span class="dot"></span> Time spent</div>

              <div class="formRow2">
                <div>
                  <div class="formLabel">Hours</div>
                  <input id="addHours" type="number" min="0" value="0" class="formInput" />
                </div>
                <div>
                  <div class="formLabel">Minutes</div>
                  <input id="addMinutes" type="number" min="0" max="59" value="0" class="formInput" />
                </div>
              </div>

              <div class="microHint" style="margin-top:10px;">
                Credits will auto-calculate based on time spent.
              </div>
            </div>

            <div class="formCard">
              <div class="sectionHead"><span class="dot"></span> Logged By</div>

              <div class="userChip" id="loggedByChip">
                <div class="userLeft">
                  <div class="userAvatar" id="loggedByAvatar"></div>
                  <div style="min-width:0">
                    <div class="userName" id="loggedByName">—</div>
                  </div>
                </div>
                <div class="userEditBtn" onclick="toggleUserPicker()">Change</div>
              </div>

              <div id="userPickerWrap" style="display:none;margin-top:12px;">
                <div class="formLabel">Select User</div>
                <select id="addUser" class="formSelect"></select>
              </div>
            </div>

            <div class="formCard">
              <div class="sectionHead"><span class="dot"></span> When did you do this?</div>
              <div class="formLabel">Date</div>
              <input id="addStartDate" type="date" class="formInput" />
            </div>

            <div class="stepActions">
              <button class="primaryBtn" onclick="goToStep(2)">Next</button>
            </div>
          </div>

          <!-- STEP 2: Task selection (TOP aligned) -->
          <div class="step" id="step-2">
            <!-- UPDATED: top aligned (not vertically centered) -->
            <div class="stepCentered stepTopAligned">
              <div class="formCard">
                <!-- UPDATED: aligned at top already; keeping clean -->
                <div class="sectionHead"><span class="dot"></span> What did you do?</div>
                <div class="formLabel">Suggested Tasks</div>
                <div class="pillRow" id="taskPills"></div>

                <div id="taskOtherWrap" style="display:none;margin-top:12px;">
                  <input id="taskOtherInput" class="formInput" placeholder="Search task" />
                </div>

                <select id="addTask" class="formSelect" style="display:none"></select>
              </div>

              <!-- UPDATED: removed micro notes + submit/skip; only Next -->
              <div class="stepActions">
                <button class="primaryBtn" onclick="goToStep(3)">Next</button>
              </div>
            </div>
          </div>

          <!-- STEP 3: Tag Client (company) -> then reveal projects -->
                    <div class="step" id="step-3">
            <div class="formCard softDisabled" id="clientCard">
              <div class="sectionHead"><span class="dot"></span> Tag a Client?</div>

              <div class="formLabel">Suggested Clients</div>
              <select id="addCompany" class="formSelect"></select>

              <!-- UPDATED: removed helper note -->
            </div>

            <!-- Project block (hidden until company selected) -->
            <div class="formCard softDisabled" id="projectCard" style="display:none;">
              <div class="sectionHead"><span class="dot"></span> Add to a Project?</div>

              <div class="formLabel">Suggested Projects</div>
              <div class="pillRow" id="projectPills"></div>

              <div id="projectOtherWrap" style="display:none;margin-top:12px;">
                <input id="projectOtherInput" class="formInput" placeholder="Search project" />
              </div>

              <select id="addProject" class="formSelect" style="display:none"></select>
            </div>

            <!-- UPDATED: only Next button -->
            <div class="stepActions">
              <button class="primaryBtn" onclick="goToStep(4)">Next</button>
            </div>
          </div>

          <!-- STEP 4: Billing + Memo + Attachments (optional end) -->
          <div class="step" id="step-4">
                        <div class="formCard">
              <div class="sectionHead"><span class="dot"></span> Billing</div>

              <!-- NEW: small recap of duration from step 1 -->
              <div class="tinyNote">
                Duration entered: <b><span id="durationTiny">0.00</span> hours</b>
                <span style="opacity:.75;">(this is the max you can allocate)</span>
              </div>

              <!-- CREDITS toggle + allocation -->
              <div class="splitRow" id="creditsSplitRow">
                <div class="left">
                  <div class="label">Use Credits</div>
                  <div class="sub">Available: <b><span id="creditsRemainingLabel">0.00</span></b> credits</div>
                </div>
                <div class="right">
                  <input id="creditsToUse" type="number" min="0" step="0.01" class="miniInput" value="0.00" />
                  <div class="miniToggle on" id="toggleUseCredits" onclick="toggleUseCredits()"></div>
                </div>
              </div>

              <!-- BILLABLE toggle + allocation -->
              <div class="splitRow" id="billableSplitRow">
                <div class="left">
                  <div class="label">Make Billable</div>
                  <div class="sub">Remainder will be billed automatically</div>
                </div>
                <div class="right">
                  <input id="billableHours" type="number" min="0" step="0.01" class="miniInput" value="0.00" />
                  <div class="miniToggle" id="toggleBillable" onclick="toggleBillable()"></div>
                </div>
              </div>

              <!-- Billable rate -->
              <div id="billableRateWrap" style="display:none;margin-top:12px;">
                <div class="formLabel">Hourly Rate</div>
                <input id="addHourlyRate" type="number" min="0" value="500" class="formInput" />
                <div class="tinyNote">
                  Standard discount: <b><span id="discountLabel">25</span>%</b>
                </div>
              </div>

              <!-- Summary -->
              <div class="billSummary" id="billSummary">
                <div class="billSummaryTitle">Billing Summary</div>
                <div class="billSummaryGrid">
                  <div class="k">Credits Used</div>
                  <div class="v"><span id="sumCreditsUsed">0.00</span></div>

                  <div class="k">Billable Before Discount</div>
                  <div class="v">$<span id="sumBeforeDiscount">0.00</span></div>

                  <div class="k">Billable After Discount</div>
                  <div class="v">$<span id="sumAfterDiscount">0.00</span></div>
                </div>
              </div>

              <div class="billError" id="billErrorBox"></div>

              <!-- Hidden fields used for submit payload -->
              <input type="hidden" id="billingUseCredits" value="1" />
              <input type="hidden" id="billingMakeBillable" value="0" />
              <input type="hidden" id="billingMode" value="split" />
            </div>


            <div class="formCard">
              <div class="sectionHead"><span class="dot"></span> Memo</div>
              <textarea id="addComments" class="formTextarea" placeholder="Add memo / notes..."></textarea>
            </div>

            <!-- UPDATED: Attachments realistic -->
            <div class="formCard">
              <div class="sectionHead"><span class="dot"></span> Attachments (Optional)</div>

              <!-- hidden input -->
              <input id="attachInput" class="fileInputHidden" type="file" multiple />

              <div class="attachStrip" onclick="openAttachmentPicker()">
                <div class="left">
                  <div class="paperclip">
                    <svg viewBox="0 0 24 24"><path d="M21 12.5l-8.5 8.5a5 5 0 0 1-7.07-7.07l9.2-9.2a3.5 3.5 0 0 1 4.95 4.95l-9.2 9.2a2 2 0 0 1-2.83-2.83l8.5-8.5"/></svg>
                  </div>
                  <div class="attachText">
                    <div class="attachTitle">Add documents or screenshots</div>
                    <div class="attachSub">Upload progress will appear below</div>
                  </div>
                </div>
                <div class="userEditBtn" style="padding:8px 12px;">Add</div>
              </div>

              <div class="attachList" id="attachList"></div>
            </div>

            <!-- UPDATED: no submit — just Next, and it finalizes -->
            <div class="stepActions">
              <button class="primaryBtn" onclick="finalizeAndClose()">Next</button>
            </div>
          </div>

        </div>
      </div>

    </div>

    <!-- bottom tabs -->
    <div class="tabs" id="tabs">
      <div class="tab">
        <svg viewBox="0 0 24 24"><path d="M3 10.5l9-7 9 7"/><path d="M9 22V12h6v10"/></svg>
        Home
      </div>
      <div class="tab">
        <svg viewBox="0 0 24 24"><path d="M16 11c1.66 0 3-1.34 3-3S17.66 5 16 5s-3 1.34-3 3 1.34 3 3 3z"/><path d="M8 11c1.66 0 3-1.34 3-3S9.66 5 8 5 5 6.34 5 8s1.34 3 3 3z"/><path d="M8 13c-2.33 0-7 1.17-7 3.5V19h14v-2.5C15 14.17 10.33 13 8 13z"/><path d="M16 13c-.29 0-.62.02-1 .05 1.16.84 2 1.94 2 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z"/></svg>
        Contacts
      </div>
      <div class="tab">
        <svg viewBox="0 0 24 24"><path d="M4 6h16v14H4z"/><path d="M8 2v4M16 2v4"/><path d="M7 10h10M7 14h10"/></svg>
        My Card
      </div>
      <div class="tab">
        <svg viewBox="0 0 24 24"><path d="M4 4h6v6H4z"/><path d="M14 4h6v6h-6z"/><path d="M4 14h6v6H4z"/><path d="M14 14h6v6h-6z"/></svg>
        Scan Card
      </div>
      <div class="tab">
        <svg viewBox="0 0 24 24"><circle cx="5" cy="12" r="1.8"/><circle cx="12" cy="12" r="1.8"/><circle cx="19" cy="12" r="1.8"/></svg>
        More
      </div>
    </div>

  </div>
</div>

<script>
/* ---------- Time log data ---------- */
const TIME_LOGS = [
  {
    total: "0 hours, 18 minutes",
    company: "Business Law Group",
    project: "Miscellaneous Legal Work",
    task: "Make Phone Call",
    comments: "Phone calls with Bobby and Angie re billing issues with Segwik and Precision Roofing",
    user: "Jessica Cahoon",
    id: "6966a11f33f73f2fcb0b6512",
    attachments: [
      { name: "Call Notes — Segwik Billing.pdf", size: 248832 }
    ]
  },
  {
    total: "0 hours, 24 minutes",
    company: "Monson Janitorial Services, Inc.",
    project: "Miscellaneous Legal Work",
    task: "Write Email",
    comments: "Email Don a draft to review for an email with James including rewrites of 2 sections of the purchase agreement.",
    user: "Jessica Cahoon",
    id: "6966a05a556808f71206a384"
  },
  {
    total: "0 hours, 18 minutes",
    company: "CorVive",
    project: "Miscellaneous Legal Work",
    task: "Review Agreement",
    comments: "Compile signatures into file and email with instructions to Plaintiff's attorney.",
    user: "Jessica Cahoon",
    id: "69669f6bc1667006d40d9df5",
    attachments: [
      { name: "Signature Packet.pdf", size: 1048576 },
      { name: "Email Instructions.msg", size: 81920 }
    ]
  },
  {
    total: "0 hours, 6 minutes",
    company: "Pure Gen Holdings, Inc.",
    project: "Miscellaneous Legal Work",
    task: "Make Phone Call",
    comments: "Follow up call from Laurie re terminated employee and needing to handle softly. Decided not to pursue cease and desist letter unless terminated employee continues behavior.",
    user: "Jessica Cahoon",
    id: "69669f4281bd973e15029cb5"
  },
  {
    total: "1 hours, 0 minutes",
    company: "CorVive",
    project: "Miscellaneous Legal Work",
    task: "Conduct Discovery",
    comments: "Review and make notes on Nicole Han deposition transcript",
    user: "George Brunt",
    id: "69650641dd07b6f2b708ccd2",
    attachments: [
      { name: "Nicole Han Deposition Transcript.pdf", size: 7340032 }
    ]
  },
  {
    total: "0 hours, 24 minutes",
    company: "Monson Janitorial Services, Inc.",
    project: "Miscellaneous Legal Work",
    task: "Draft Agreement",
    comments: "Review updated employment agreements. Update promissory notes. Email Don regarding the same.",
    user: "Jessica Cahoon",
    id: "69615cd215cf84564b0bc3f3"
  },
  {
    total: "0 hours, 30 minutes",
    company: "Relive the Magic at Home",
    project: "Miscellaneous Legal Work",
    task: "Draft Pleadings",
    comments: "Review Final and File",
    user: "George Brunt",
    id: "696117e50a37f50c55086544",
    attachments: [
      { name: "Final Pleading Draft.docx", size: 356352 },
      { name: "Filed Copy (Stamped).pdf", size: 512000 }
    ]
  },
  {
    total: "0 hours, 12 minutes",
    company: "Relive the Magic at Home",
    project: "Miscellaneous Legal Work",
    task: "Conduct Investigation",
    comments: "Opposition to Wicks proposed registration",
    user: "George Brunt",
    id: "696117b8f39d42f0e70ee822"
  },
  {
    total: "1 hours, 18 minutes",
    company: "CorVive",
    project: "Miscellaneous Legal Work",
    task: "Conduct Research",
    comments: "Research class action suit",
    user: "George Brunt",
    id: "6960058c74ef3e89a50e7d34",
    attachments: [
      { name: "Research Summary — Class Action.pdf", size: 629145 },
      { name: "Case Law Excerpts.pdf", size: 2097152 },
      { name: "Statutes & Notes.txt", size: 32768 }
    ]
  }
];

/* ---------- Add Time Log dropdown options ---------- */
const COMPANY_OPTIONS = [
  "Business Law Group",
  "Monson Janitorial Services, Inc.",
  "CorVive",
  "Pure Gen Holdings, Inc.",
  "Relive the Magic at Home"
];

const PROJECT_OPTIONS = [
  "Miscellaneous Legal Work",
  "Contract Review",
  "Litigation Support",
  "Employment Matters",
  "Trademark / IP"
];

const TASK_OPTIONS = [
  "Make Phone Call",
  "Write Email",
  "Review Agreement",
  "Draft Agreement",
  "Conduct Research",
  "Conduct Discovery"
];

const USER_OPTIONS = [
  "Jessica Cahoon",
  "George Brunt",
  "Lindsay Germann",
  "Stephanie Griffey",
  "Joseph Wadsworth"
];

/* ---------- Views data ---------- */
const TIME_LOG_VIEWS = [
  { name: "Lindsay Germann", tag: "This Month" },
  { name: "Jessica Cahoon", tag: "This Month" },
  { name: "Stephanie Griffey", tag: "This Month" },
  { name: "Stephanie Keller", tag: "Last Month" },
  { name: "George Brunt", tag: "This Month" },
  { name: "Joseph Wadsworth", tag: "Last Month" },
  { name: "Lawrence Tuttle", tag: "Last Month" },
  { name: "Todd Pingel", tag: "Billing" },
  { name: "All Logged Time", tag: "This Month" },
  { name: "Paul Ivy", tag: "This Month" },
  { name: "Finalizing Monthly Invoices", tag: "" },
  { name: "Last Month’s Work by Attorney", tag: "" }
];

/* ---------- Helpers ---------- */
function compactTime(str){
  const h = (str.match(/(\d+)\s*hours?/)||[])[1] || "0";
  const m = (str.match(/(\d+)\s*minutes?/)||[])[1] || "0";
  return `${h}h ${m}m`;
}
function initialsFromCompany(company){
  const parts = String(company||'').replace(/[^a-zA-Z0-9 ]/g,'').trim().split(/\s+/).slice(0,2);
  if(!parts.length) return "TL";
  return parts.map(p=>p[0].toUpperCase()).join('');
}
function attorneyPhotoUrl(user){
  const u = String(user||"").toLowerCase();
  if(u.includes("jessica")) return "https://d34hmiuaex7c0.cloudfront.net/5052/uploads/profile/staffuser/5060/1666032537644.jpg";
  if(u.includes("george")) return "https://d34hmiuaex7c0.cloudfront.net/5052/uploads/profile/staffuser/5054/1665766283321.jpeg";
  return "";
}
function escapeHtml(str){
  return String(str||'')
    .replaceAll('&','&amp;')
    .replaceAll('<','&lt;')
    .replaceAll('>','&gt;');
}
function escapeAttr(s){
  return String(s||"").replaceAll("'", "\\'").replaceAll('"', '&quot;');
}
function formatBytes(bytes){
  const b = Number(bytes||0);
  if(!b) return "—";
  const kb = b/1024;
  const mb = kb/1024;
  if(mb >= 1) return `${mb.toFixed(1)} MB`;
  return `${Math.max(1, Math.round(kb))} KB`;
}

/* ---------- Render list ---------- */
const listEl = document.getElementById('list');

function rowHTML(item, idx){
  const t = compactTime(item.total);
  const photo = attorneyPhotoUrl(item.user);
  return `
    <div class="row" data-idx="${idx}">
      <div class="avatar">
        ${photo ? `<img src="${photo}" alt="${escapeHtml(item.user)}" />` : `${initialsFromCompany(item.company)}`}
      </div>

      <div class="meta">
        <div class="line1">
          <span class="t">${t}</span>
          <span class="dot">·</span>
          <span>${item.company}</span>
        </div>
        <div class="line2">${item.task} · ${item.project}</div>
      </div>

      <div class="chev">
        <svg viewBox="0 0 24 24"><path d="M9 18l6-6-6-6"/></svg>
      </div>
    </div>
  `;
}

function renderList(filter=""){
  const q = (filter||"").trim().toLowerCase();
  const rows = TIME_LOGS
    .map((x,i)=>({x,i}))
    .filter(({x})=>{
      if(!q) return true;
      const hay = `${x.total} ${x.company} ${x.project} ${x.task} ${x.comments} ${x.user} ${x.id}`.toLowerCase();
      return hay.includes(q);
    });

  listEl.innerHTML = rows.map(({x,i})=>rowHTML(x,i)).join('');

  listEl.querySelectorAll('.row').forEach(r=>{
    r.addEventListener('click', ()=>{
      const idx = parseInt(r.getAttribute('data-idx'),10);
      openDetails(idx);
    });
  });
}

document.getElementById('q').addEventListener('input', (e)=>renderList(e.target.value));

/* ---------- Navigation ---------- */
const screenList = document.getElementById('screen-list');
const screenDetails = document.getElementById('screen-details');
const screenViews = document.getElementById('screen-views');
const screenAdd = document.getElementById('screen-add');
const tabsEl = document.getElementById('tabs');

function navToDetails(){
  screenDetails.classList.remove('hidden');
  screenDetails.classList.add('off-right');
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    screenList.classList.add('off-left');
    screenDetails.classList.remove('off-right');
  }));
  setTimeout(()=>{
    screenList.classList.add('hidden');
    screenList.classList.remove('off-left');
  }, 360);
}

function navBack(){
  screenList.classList.remove('hidden');
  screenList.classList.remove('off-left','off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    screenDetails.classList.add('off-right');
  }));

  setTimeout(()=>{
    screenDetails.classList.add('hidden');
    screenDetails.classList.remove('off-right');
  }, 360);
}

/* ---------- Views navigation ---------- */
function openViews(){
  renderViews("");

  tabsEl.classList.add('hidden');

  screenViews.classList.remove('hidden');
  screenViews.classList.add('off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    screenList.classList.add('off-left');
    screenViews.classList.remove('off-right');
  }));

  setTimeout(()=>{
    screenList.classList.add('hidden');
    screenList.classList.remove('off-left');
  }, 360);
}

function closeViews(){
  screenList.classList.remove('hidden');
  screenList.classList.remove('off-left','off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    screenViews.classList.add('off-right');
  }));

  setTimeout(()=>{
    screenViews.classList.add('hidden');
    screenViews.classList.remove('off-right');
    tabsEl.classList.remove('hidden');
  }, 360);
}

/* ---------- Add Time Log navigation ---------- */
function openAddTimeLog(){
  initAddForm();

  tabsEl.classList.add('hidden');

  screenAdd.classList.remove('hidden');
  screenAdd.classList.add('off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    screenList.classList.add('off-left');
    screenAdd.classList.remove('off-right');
  }));

  setTimeout(()=>{
    screenList.classList.add('hidden');
    screenList.classList.remove('off-left');
  }, 360);

  // NEW: always start at Step 1
  goToStep(1, true);
}

function closeAddTimeLog(){
  screenList.classList.remove('hidden');
  screenList.classList.remove('off-left','off-right');

  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    screenAdd.classList.add('off-right');
  }));

  setTimeout(()=>{
    screenAdd.classList.add('hidden');
    screenAdd.classList.remove('off-right');
    tabsEl.classList.remove('hidden');
  }, 360);
}

/* ---------- Views render + search ---------- */
const viewsListEl = document.getElementById('viewsList');
const viewSearchEl = document.getElementById('viewSearch');

function renderViews(filter=""){
  const q = (filter||"").trim().toLowerCase();
  const rows = TIME_LOG_VIEWS.filter(v=>{
    if(!q) return true;
    const hay = `${v.name} ${v.tag}`.toLowerCase();
    return hay.includes(q);
  });

  viewsListEl.innerHTML = rows.map(v=>{
    const label = v.tag ? `${v.name} — ${v.tag}` : v.name;
    return `<div class="pill" onclick="pickView('${escapeAttr(label)}')">${label}</div>`;
  }).join('');
}

viewSearchEl.addEventListener('input', (e)=>renderViews(e.target.value));

/* ---------- Add Time Log behavior ---------- */
function fillSelect(selectEl, options, placeholder){
  selectEl.innerHTML = '';
  if(placeholder){
    const o = document.createElement('option');
    o.value = '';
    o.textContent = placeholder;
    o.disabled = true;
    o.selected = true;
    selectEl.appendChild(o);
  }
  options.forEach(v=>{
    const opt = document.createElement('option');
    opt.value = v;
    opt.textContent = v;
    selectEl.appendChild(opt);
  });
}

const LOGGED_IN_USER = "Jessica Cahoon";
/* =========================
   NEW: Split Billing State
   ========================= */

// Example: remaining credits for this company/user context
// (Replace later with company profile lookup)
const CREDITS_REMAINING = 0.60;

// Example: standard discount pulled from company profile
const COMPANY_STANDARD_DISCOUNT_PCT = 25;

function to2(n){
  const x = Number(n || 0);
  return (Math.round(x * 100) / 100).toFixed(2);
}

function clamp(n, min, max){
  const x = Number(n || 0);
  if(Number.isNaN(x)) return min;
  return Math.min(max, Math.max(min, x));
}

function durationHoursFloat(){
  const hours = parseInt(document.getElementById('addHours').value || "0", 10);
  const minutes = parseInt(document.getElementById('addMinutes').value || "0", 10);
  const safeMinutes = Math.max(0, Math.min(59, minutes));
  return Math.max(0, hours) + (safeMinutes / 60);
}

function updateDurationTiny(){
  const dur = durationHoursFloat();
  const el = document.getElementById('durationTiny');
  if(el) el.textContent = to2(dur);

  const remEl = document.getElementById('creditsRemainingLabel');
  if(remEl) remEl.textContent = to2(CREDITS_REMAINING);

  const discEl = document.getElementById('discountLabel');
  if(discEl) discEl.textContent = String(COMPANY_STANDARD_DISCOUNT_PCT);
}

function toggleUseCredits(){
  const t = document.getElementById('toggleUseCredits');
  const hidden = document.getElementById('billingUseCredits');
  const creditsInput = document.getElementById('creditsToUse');
  if(!t || !hidden) return;

  const isOn = t.classList.contains('on');

  if(isOn){
    // TURN OFF credits
    t.classList.remove('on');
    hidden.value = "0";

    if(creditsInput){
      creditsInput.value = to2(0);
      creditsInput.disabled = true;
      creditsInput.style.opacity = ".55";
      creditsInput.style.cursor = "not-allowed";
    }
  } else {
    // TURN ON credits
    t.classList.add('on');
    hidden.value = "1";

    if(creditsInput){
      creditsInput.disabled = false;
      creditsInput.style.opacity = "1";
      creditsInput.style.cursor = "text";

      // SMART PREFILL
      const dur = durationHoursFloat();
      const prefill = Math.min(dur, CREDITS_REMAINING);
      creditsInput.value = to2(prefill);
    }
  }

  recomputeBillingSplit(true);
}


function toggleBillable(){
  const t = document.getElementById('toggleBillable');
  const hidden = document.getElementById('billingMakeBillable');
  if(!t || !hidden) return;

  const isOn = t.classList.contains('on');
  if(isOn){
    t.classList.remove('on');
    hidden.value = "0";
  } else {
    t.classList.add('on');
    hidden.value = "1";
  }

  // show/hide hourly rate
  const wrap = document.getElementById('billableRateWrap');
  if(wrap){
    wrap.style.display = (!isOn) ? "block" : "none";
  }

  recomputeBillingSplit(true);
}

function setBillingError(msg){
  const box = document.getElementById('billErrorBox');
  if(!box) return;
  if(msg){
    box.textContent = msg;
    box.classList.add('show');
  } else {
    box.textContent = "";
    box.classList.remove('show');
  }
}

function recomputeBillingSplit(forceNormalize=false){
  // Only runs if Step 4 elements exist
  const creditsInput = document.getElementById('creditsToUse');
  const billableInput = document.getElementById('billableHours');
  const useCredits = document.getElementById('billingUseCredits');
  const makeBillable = document.getElementById('billingMakeBillable');
  if(!creditsInput || !billableInput || !useCredits || !makeBillable) return;

  const dur = durationHoursFloat();

  // Toggle state
  const useCreditsOn = (useCredits.value === "1");
  const billableOn = (makeBillable.value === "1");

  // If neither selected, default to credits on
  if(!useCreditsOn && !billableOn){
    document.getElementById('toggleUseCredits')?.classList.add('on');
    useCredits.value = "1";
  }

  // Parse inputs
  let creditsToUse = clamp(parseFloat(creditsInput.value || "0"), 0, 999999);
  let billableHours = clamp(parseFloat(billableInput.value || "0"), 0, 999999);

  // Credits rules
  if(!useCreditsOn){
    creditsToUse = 0;
    creditsInput.value = to2(0);
    creditsInput.disabled = true;
    creditsInput.style.opacity = ".55";
    creditsInput.style.cursor = "not-allowed";
  } else {
    creditsInput.disabled = false;
    creditsInput.style.opacity = "1";
    creditsInput.style.cursor = "text";
  }


  // Billable rules
  if(!billableOn){
    billableHours = 0;
    billableInput.value = to2(0);
  }

  // Auto-normalize behavior:
  // - credits max = min(duration, credits remaining)
  // - if billable on, billable becomes remainder (duration - credits used)
  // - user can type either input; we enforce total not exceeding duration
  const creditsMax = Math.min(dur, CREDITS_REMAINING);

  if(forceNormalize){
    // If user typed credits, clamp credits, then remainder billable
    creditsToUse = clamp(creditsToUse, 0, creditsMax);
    if(billableOn){
      billableHours = Math.max(0, dur - creditsToUse);
    } else {
      // no billable: credits cannot exceed duration
      creditsToUse = clamp(creditsToUse, 0, dur);
    }
  }

  // Total validation: cannot exceed duration
  const totalAlloc = creditsToUse + billableHours;
  if(totalAlloc > dur + 0.0001){
    // Reduce billable first if enabled, otherwise reduce credits
    const over = totalAlloc - dur;
    if(billableOn && billableHours > 0){
      billableHours = Math.max(0, billableHours - over);
    } else {
      creditsToUse = Math.max(0, creditsToUse - over);
    }
  }

  // Final clamp again
  creditsToUse = clamp(creditsToUse, 0, creditsMax);
  billableHours = clamp(billableHours, 0, dur);

  // If billable is ON, ensure remainder is accurate
  if(billableOn){
    billableHours = Math.max(0, dur - creditsToUse);
  }

  // If credits is OFF, ensure billable is full duration when ON
  if(!useCreditsOn && billableOn){
    billableHours = dur;
  }

  // Persist back into inputs
  creditsInput.value = to2(creditsToUse);
  billableInput.value = to2(billableHours);

  // Show duration mismatch error if can't allocate correctly
  // (Allow minor floating error)
  const finalTotal = creditsToUse + billableHours;
  const diff = Math.abs(finalTotal - dur);

  if(diff > 0.02){
    setBillingError(`Billing allocation must equal duration (${to2(dur)} hrs). Current: ${to2(finalTotal)} hrs.`);
  } else {
    setBillingError("");
  }

  // Summary
  const hourlyRate = parseFloat(document.getElementById('addHourlyRate')?.value || "0");
  const beforeDiscount = billableHours * hourlyRate;
  const afterDiscount = beforeDiscount * (1 - (COMPANY_STANDARD_DISCOUNT_PCT / 100));

  const sumCreditsUsed = document.getElementById('sumCreditsUsed');
  const sumBefore = document.getElementById('sumBeforeDiscount');
  const sumAfter = document.getElementById('sumAfterDiscount');

  if(sumCreditsUsed) sumCreditsUsed.textContent = to2(creditsToUse);
  if(sumBefore) sumBefore.textContent = to2(beforeDiscount);
  if(sumAfter) sumAfter.textContent = to2(afterDiscount);
}

const USER_RATES = {
  "Jessica Cahoon": 500,
  "George Brunt": 450,
  "Lindsay Germann": 400,
  "Stephanie Griffey": 425,
  "Joseph Wadsworth": 350
};

const TASK_SUGGESTIONS = [
  "Make Phone Call",
  "Write Email",
  "Review Agreement",
  "Draft Agreement",
  "Conduct Research",
  "Conduct Discovery"
];

const PROJECT_SUGGESTIONS = [
  { project: "Miscellaneous Legal Work", company: "Business Law Group" },
  { project: "Contract Review", company: "CorVive" },
  { project: "Litigation Support", company: "Relive the Magic at Home" },
  { project: "Employment Matters", company: "Pure Gen Holdings, Inc." },
  { project: "Trademark / IP", company: "Monson Janitorial Services, Inc." },
  { project: "Miscellaneous Legal Work", company: "CorVive" }
];

function ensureOptionValue(selectEl, value){
  const exists = Array.from(selectEl.options).some(o=>o.value === value);
  if(!exists){
    const opt = document.createElement('option');
    opt.value = value;
    opt.textContent = value;
    selectEl.appendChild(opt);
  }
}

/* ---- NEW: Step navigation + history ---- */
let ADD_STEP = 1;
let ADD_STEP_STACK = [1];

function goToStep(n, resetStack=false){
  if(resetStack){
    ADD_STEP_STACK = [n];
  } else {
    const last = ADD_STEP_STACK[ADD_STEP_STACK.length-1];
    if(last !== n) ADD_STEP_STACK.push(n);
  }
  ADD_STEP = n;

  document.querySelectorAll('#addStepper .step').forEach(s=>s.classList.remove('active'));
  const target = document.getElementById(`step-${n}`);
  if(target) target.classList.add('active');

  const wrap = document.getElementById('addStepper');
  if(wrap) wrap.scrollTop = 0;

  // NEW: when arriving at Billing step, smart-prefill credits + recompute
  if(n === 4){
    updateDurationTiny();

    const creditsInput = document.getElementById('creditsToUse');
    const useCreditsOn = (document.getElementById('billingUseCredits')?.value === "1");

    if(creditsInput){
      if(useCreditsOn){
        creditsInput.disabled = false;
        creditsInput.style.opacity = "1";
        creditsInput.style.cursor = "text";

        const dur = durationHoursFloat();
        const prefill = Math.min(dur, CREDITS_REMAINING);
        creditsInput.value = to2(prefill);
      } else {
        creditsInput.value = to2(0);
        creditsInput.disabled = true;
        creditsInput.style.opacity = ".55";
        creditsInput.style.cursor = "not-allowed";
      }
    }

    recomputeBillingSplit(true);
  }
}


/* UPDATED: back button logic for entry flow */
function addBack(){
  if(ADD_STEP_STACK.length > 1){
    ADD_STEP_STACK.pop();
    const prev = ADD_STEP_STACK[ADD_STEP_STACK.length-1] || 1;
    ADD_STEP = prev;

    document.querySelectorAll('#addStepper .step').forEach(s=>s.classList.remove('active'));
    const target = document.getElementById(`step-${prev}`);
    if(target) target.classList.add('active');

    const wrap = document.getElementById('addStepper');
    if(wrap) wrap.scrollTop = 0;
    return;
  }
  // If we're already at step 1, then exit Add flow (original behavior)
  closeAddTimeLog();
}

/* ---- Credits calc (dynamic) ---- */
function calcCreditsFromDuration(){
  const hours = parseInt(document.getElementById('addHours').value || "0", 10);
  const minutes = parseInt(document.getElementById('addMinutes').value || "0", 10);
  const safeMinutes = Math.max(0, Math.min(59, minutes));
  const totalHours = Math.max(0, hours) + (safeMinutes / 60);

  // 1 credit per hour
  const credits = totalHours;

  // format nice
  const rounded = Math.round(credits * 100) / 100;
  return (rounded % 1 === 0) ? `${rounded.toFixed(0)}` : `${rounded.toFixed(2)}`;
}

function updateCreditsLabel(){
  const labelEl = document.getElementById('creditsLabel');
  if(labelEl) labelEl.textContent = calcCreditsFromDuration();

  // NEW: also update Step 4 split UI if it exists
  updateDurationTiny();
  recomputeBillingSplit();
}


/* ---- Logged By ---- */
function syncLoggedByChip(){
  const user = document.getElementById('addUser').value || LOGGED_IN_USER;
  document.getElementById('loggedByName').textContent = user;

  const av = document.getElementById('loggedByAvatar');
  const url = attorneyPhotoUrl(user);
  av.innerHTML = url
    ? `<img src="${url}" alt="${escapeHtml(user)}" />`
    : `<span style="font-weight:800;color:var(--accent)">${user.split(' ').map(x=>x[0]).join('').slice(0,2).toUpperCase()}</span>`;
}
function toggleUserPicker(){
  const wrap = document.getElementById('userPickerWrap');
  wrap.style.display = (wrap.style.display === "none") ? "block" : "none";
}

/* ---- Task pills ---- */
function buildTaskPills(){
  const pillWrap = document.getElementById('taskPills');
  pillWrap.innerHTML = '';

  const tasks = TASK_SUGGESTIONS.slice(0,6);

  tasks.forEach(t=>{
    const pill = document.createElement('div');
    pill.className = 'choicePill';
    pill.textContent = t;
    pill.onclick = ()=> selectTaskPill(t);
    pillWrap.appendChild(pill);
  });

  const other = document.createElement('div');
  other.className = 'choicePill otherPill';
  other.textContent = `Other Task`;
  other.onclick = ()=> selectTaskPill('__other__');
  pillWrap.appendChild(other);

  selectTaskPill(tasks[0]);
}

function selectTaskPill(task){
  document.querySelectorAll('#taskPills .choicePill').forEach(p=>p.classList.remove('active'));
  const pills = Array.from(document.querySelectorAll('#taskPills .choicePill'));
  const match = pills.find(p=>p.textContent.trim() === task || (task==='__other__' && p.textContent.includes('Other Task')));
  if(match) match.classList.add('active');

  if(task === '__other__'){
    const otherPill = pills.find(p=>p.textContent.includes('Other Task'));
    if(otherPill) otherPill.style.display = "none";

    document.getElementById('taskOtherWrap').style.display = "block";
    document.getElementById('taskOtherInput').focus();
    document.getElementById('addTask').value = "";
  } else {
    const otherPill = pills.find(p=>p.textContent.includes('Other Task'));
    if(otherPill) otherPill.style.display = "inline-flex";

    document.getElementById('taskOtherWrap').style.display = "none";
    ensureOptionValue(document.getElementById('addTask'), task);
    document.getElementById('addTask').value = task;
  }
}

/* ---- Project pills ---- */
function buildProjectPills(){
  const wrap = document.getElementById('projectPills');
  wrap.innerHTML = '';

  const rows = PROJECT_SUGGESTIONS.slice(0,6);

  rows.forEach(r=>{
    const pill = document.createElement('div');
    pill.className = 'choicePill';
    pill.innerHTML = `${r.project}`;
    pill.onclick = ()=>{
      selectProjectPill(r.project);
      if(!document.getElementById('addCompany').value){
        ensureOptionValue(document.getElementById('addCompany'), r.company);
        document.getElementById('addCompany').value = r.company;
      }
    };
    wrap.appendChild(pill);
  });

  const other = document.createElement('div');
  other.className = 'choicePill otherPill';
  other.textContent = `Other Project`;
  other.onclick = ()=> selectProjectPill('__other__');
  wrap.appendChild(other);

  selectProjectPill(rows[0].project);
}

function selectProjectPill(project){
  document.querySelectorAll('#projectPills .choicePill').forEach(p=>p.classList.remove('active'));
  const pills = Array.from(document.querySelectorAll('#projectPills .choicePill'));
  const match = pills.find(p=>{
    if(project === '__other__') return p.textContent.includes('Other Project');
    return p.textContent.includes(project);
  });
  if(match) match.classList.add('active');

  if(project === '__other__'){
    const otherPill = pills.find(p=>p.textContent.includes('Other Project'));
    if(otherPill) otherPill.style.display = "none";

    document.getElementById('projectOtherWrap').style.display = "block";
    document.getElementById('projectOtherInput').focus();
    document.getElementById('addProject').value = "";
  } else {
        // NEW: project selected -> project card becomes engaged (no longer muted)
    const projectCard = document.getElementById('projectCard');
    if(projectCard){
      projectCard.classList.add('engaged');
      projectCard.classList.remove('softDisabled');
    }

    const otherPill = pills.find(p=>p.textContent.includes('Other Project'));
    if(otherPill) otherPill.style.display = "inline-flex";

    document.getElementById('projectOtherWrap').style.display = "none";
    ensureOptionValue(document.getElementById('addProject'), project);
    document.getElementById('addProject').value = project;
  }
}

/* ---- Billing choice ---- */
function pickBillingMode(mode){
  const creditsPill = document.getElementById('pillCredits');
  const billablePill = document.getElementById('pillBillable');

  creditsPill.classList.remove('active');
  billablePill.classList.remove('active');

  if(mode === 'credits'){
    creditsPill.classList.add('active');
    document.getElementById('billableRateWrap').style.display = "none";
    document.getElementById('billingMode').value = "credits";
  } else {
    billablePill.classList.add('active');
    document.getElementById('billableRateWrap').style.display = "block";
    document.getElementById('billingMode').value = "billable";
  }
}

/* ---- Rate ---- */
function syncRateToUser(){
  const user = document.getElementById('addUser').value || LOGGED_IN_USER;
  const rate = USER_RATES[user] ?? 500;
  document.getElementById('addHourlyRate').value = rate;
}

/* ---- reveal projects only after client chosen ---- */
function handleCompanySelect(){
  const companyEl = document.getElementById('addCompany');
  const company = companyEl.value;

  const clientCard = document.getElementById('clientCard');
  if(clientCard){
    if(company){
      // selected -> engage
      clientCard.classList.add('engaged');
      clientCard.classList.remove('softDisabled');
    } else {
      // nothing selected -> stay muted
      clientCard.classList.remove('engaged');
      clientCard.classList.add('softDisabled');
    }
  }

  const projectCard = document.getElementById('projectCard');
  if(projectCard){
    projectCard.style.display = company ? "block" : "none";

    if(company){
      // shown but still muted until project chosen
      projectCard.classList.remove('engaged');
      projectCard.classList.add('softDisabled');
    }
  }
}



/* ---- Attachments realistic + fake loader ---- */
let ATTACH_UPLOADS = [];
/* =========================
   NEW: Details attachments (editable demo)
   - Always visible in Time Log Details
   - Mirrors TIME_LOGS[idx].attachments (if present)
   ========================= */
let DETAILS_ATTACHMENTS = [];
let DETAILS_ACTIVE_IDX = null;

function openDetailsAttachmentPicker(){
  const input = document.getElementById('detailsAttachInput');
  if(input) input.click();
}

function formatSizeFromAttachment(a){
  // supports both {size:number} and string
  if(a && typeof a.size === 'number') return formatBytes(a.size);
  return a && a.size ? String(a.size) : "—";
}

function renderDetailsAttachments(){
  const list = document.getElementById('detailsAttachList');
  if(!list) return;

  // Always visible even when empty
  if(!DETAILS_ATTACHMENTS.length){
    list.innerHTML = `
      <div class="detailFileRow">
        <div class="detailFileTop">
          <div class="detailFileMeta" style="min-width:0">
            <div class="detailFileName" style="color:#64748b;font-weight:800;">No attachments yet</div>
            <div class="detailFileSub">Add a document, screenshot, or file for this time log.</div>
          </div>
        </div>
      </div>
    `;
    return;
  }

  list.innerHTML = DETAILS_ATTACHMENTS.map(f=>`
    <div class="detailFileRow" data-id="${f.id}">
      <div class="detailFileTop">
        <div class="detailFileMeta" style="min-width:0">
          <div class="detailFileName">${escapeHtml(f.name)}</div>
          <div class="detailFileSub">${escapeHtml(f.sizeLabel || "—")}</div>
        </div>
        <div class="detailFileRight">
          <div class="detailFileRemove" onclick="removeDetailsAttachment('${f.id}')" title="Remove">
            <svg viewBox="0 0 24 24"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
          </div>
        </div>
      </div>
    </div>
  `).join('');
}

function removeDetailsAttachment(id){
  DETAILS_ATTACHMENTS = DETAILS_ATTACHMENTS.filter(x=>x.id !== id);
  persistDetailsAttachmentsToLog();
  renderDetailsAttachments();
}

function persistDetailsAttachmentsToLog(){
  if(DETAILS_ACTIVE_IDX === null) return;
  const log = TIME_LOGS[DETAILS_ACTIVE_IDX];
  if(!log) return;

  // Persist into the same model TIME_LOGS uses
  log.attachments = DETAILS_ATTACHMENTS.map(x=>({
    name: x.name,
    size: x.sizeRaw || 0
  }));
}

function loadDetailsAttachmentsFromLog(idx){
  DETAILS_ACTIVE_IDX = idx;

  const log = TIME_LOGS[idx] || {};
  const existing = Array.isArray(log.attachments) ? log.attachments : [];

  DETAILS_ATTACHMENTS = existing.map(a=>({
    id: "da_" + Math.random().toString(16).slice(2),
    name: a.name || "Untitled file",
    sizeRaw: (typeof a.size === "number") ? a.size : 0,
    sizeLabel: formatBytes((typeof a.size === "number") ? a.size : 0)
  }));

  renderDetailsAttachments();

  const input = document.getElementById('detailsAttachInput');
  if(input){
    input.value = "";
    input.onchange = (e)=> onDetailsFilesSelected(e.target.files);
  }
}

function onDetailsFilesSelected(files){
  const arr = Array.from(files || []);
  arr.forEach(file=>{
    DETAILS_ATTACHMENTS.unshift({
      id: "da_" + Math.random().toString(16).slice(2),
      name: file.name || "Untitled file",
      sizeRaw: file.size || 0,
      sizeLabel: formatBytes(file.size || 0)
    });
  });

  persistDetailsAttachmentsToLog();
  renderDetailsAttachments();
}

function openAttachmentPicker(){
  const input = document.getElementById('attachInput');
  if(input) input.click();
}

function renderAttachments(){
  const list = document.getElementById('attachList');
  if(!list) return;

  list.innerHTML = ATTACH_UPLOADS.map(f=>`
    <div class="fileRow" data-id="${f.id}">
      <div class="fileTop">
        <div class="fileMeta" style="min-width:0">
          <div class="fileName">${escapeHtml(f.name)}</div>
          <div class="fileSub">${escapeHtml(f.sizeLabel)} · ${f.done ? "Uploaded" : "Uploading..."}</div>
        </div>
        <div class="fileRight">
          <div class="filePct">${f.done ? "100%" : `${Math.min(99, Math.round(f.pct))}%`}</div>
          <div class="fileRemove" onclick="removeAttachment('${f.id}')" title="Remove">
            <svg viewBox="0 0 24 24"><path d="M18 6L6 18"/><path d="M6 6l12 12"/></svg>
          </div>
        </div>
      </div>
      <div class="progTrack">
        <div class="progBar" style="width:${f.done ? 100 : Math.max(2, f.pct)}%"></div>
      </div>
    </div>
  `).join('');
}

function removeAttachment(id){
  ATTACH_UPLOADS = ATTACH_UPLOADS.filter(x=>x.id !== id);
  renderAttachments();
}

function startFakeUpload(id){
  const tick = ()=>{
    const idx = ATTACH_UPLOADS.findIndex(x=>x.id === id);
    if(idx === -1) return;

    const item = ATTACH_UPLOADS[idx];
    if(item.done) return;

    // accelerate near end
    const bump = (item.pct < 80) ? (8 + Math.random()*10) : (3 + Math.random()*6);
    item.pct = Math.min(100, item.pct + bump);

    if(item.pct >= 100){
      item.pct = 100;
      item.done = true;
    }

    ATTACH_UPLOADS[idx] = item;
    renderAttachments();

    if(!item.done){
      setTimeout(tick, 220 + Math.random()*180);
    }
  };
  setTimeout(tick, 180);
}

function onFilesSelected(files){
  const arr = Array.from(files || []);
  arr.forEach(file=>{
    const id = "f_" + Math.random().toString(16).slice(2);
    ATTACH_UPLOADS.unshift({
      id,
      name: file.name || "Untitled file",
      sizeLabel: formatBytes(file.size || 0),
      pct: 0,
      done: false
    });
    startFakeUpload(id);
  });
  renderAttachments();
}

/* ---- finalize: creates the log + closes ---- */
function finalizeAndClose(){
  submitNewTimeLog();
}

function initAddForm(){
  fillSelect(document.getElementById('addCompany'), COMPANY_OPTIONS, "Select Client...");
  fillSelect(document.getElementById('addProject'), PROJECT_OPTIONS, "Select Project...");
  fillSelect(document.getElementById('addTask'), TASK_OPTIONS, "Select Task...");
  fillSelect(document.getElementById('addUser'), USER_OPTIONS, "Select User...");

  // defaults
  document.getElementById('addHours').value = 0;
  document.getElementById('addMinutes').value = 0;

  // default user
  document.getElementById('addUser').value = LOGGED_IN_USER;
  syncLoggedByChip();
  syncRateToUser();

  // default date = today
  const now = new Date();
  const pad = n => String(n).padStart(2,'0');
  const today = `${now.getFullYear()}-${pad(now.getMonth()+1)}-${pad(now.getDate())}`;
  document.getElementById('addStartDate').value = today;

  // billing default (NEW split billing)
  // default: use credits ON; billable OFF
  const tCredits = document.getElementById('toggleUseCredits');
  const tBillable = document.getElementById('toggleBillable');
  const useCredits = document.getElementById('billingUseCredits');
  const makeBillable = document.getElementById('billingMakeBillable');

  if(tCredits) tCredits.classList.add('on');
  if(useCredits) useCredits.value = "1";

  if(tBillable) tBillable.classList.remove('on');
  if(makeBillable) makeBillable.value = "0";

  const rateWrap = document.getElementById('billableRateWrap');
  if(rateWrap) rateWrap.style.display = "none";

  // defaults for split inputs
  const ctu = document.getElementById('creditsToUse');
  if(ctu){
    ctu.value = to2(Math.min(durationHoursFloat(), CREDITS_REMAINING));
    ctu.disabled = false;
    ctu.style.opacity = "1";
    ctu.style.cursor = "text";
  }

  if(document.getElementById('billableHours')) document.getElementById('billableHours').value = to2(Math.max(0, durationHoursFloat() - Math.min(durationHoursFloat(), CREDITS_REMAINING)));

  updateDurationTiny();
  recomputeBillingSplit(true);


  // comments reset
  document.getElementById('addComments').value = "";

  // pills
  buildTaskPills();
  buildProjectPills();

  // hide wraps
  document.getElementById('taskOtherWrap').style.display = "none";
  document.getElementById('projectOtherWrap').style.display = "none";
  document.getElementById('userPickerWrap').style.display = "none";

  // project hidden until company selected
  document.getElementById('projectCard').style.display = "none";
// force client card to start muted
const clientCard = document.getElementById('clientCard');
if(clientCard){
  clientCard.classList.remove('engaged');
  clientCard.classList.add('softDisabled');
}

  // dynamic credits
  updateCreditsLabel();

  // wire listeners
  document.getElementById('addUser').onchange = ()=>{
    syncLoggedByChip();
    syncRateToUser();
  };

  const hoursEl = document.getElementById('addHours');
  const minsEl = document.getElementById('addMinutes');
  hoursEl.oninput = ()=>{
    updateCreditsLabel();
    updateDurationTiny();
    recomputeBillingSplit(true);
  };
  minsEl.oninput = ()=>{
    updateCreditsLabel();
    updateDurationTiny();
    recomputeBillingSplit(true);
  };


  document.getElementById('taskOtherInput').value = "";
  document.getElementById('projectOtherInput').value = "";

  document.getElementById('taskOtherInput').oninput = ()=>{
    const val = document.getElementById('taskOtherInput').value.trim();
    if(val){
      ensureOptionValue(document.getElementById('addTask'), val);
      document.getElementById('addTask').value = val;
    }
  };

  document.getElementById('projectOtherInput').oninput = ()=>{
    const val = document.getElementById('projectOtherInput').value.trim();
    if(val){
      ensureOptionValue(document.getElementById('addProject'), val);
      document.getElementById('addProject').value = val;
    }
  };

  // company select triggers reveal
  const addCompanyEl = document.getElementById('addCompany');
  addCompanyEl.onchange = handleCompanySelect;

 addCompanyEl.onfocus = ()=>{};

  // NEW: project card engages when user focuses project dropdown
  const addProjectEl = document.getElementById('addProject');
  if(addProjectEl){
    addProjectEl.onfocus = ()=>{
      const pc = document.getElementById('projectCard');
      if(pc){
        pc.classList.add('engaged');
        pc.classList.remove('softDisabled');
      }
    };
  }

  handleCompanySelect();
  // NEW: Step 4 billing listeners
  const creditsToUseEl = document.getElementById('creditsToUse');
  const billableHoursEl = document.getElementById('billableHours');
  const hourlyRateEl = document.getElementById('addHourlyRate');

  if(creditsToUseEl){
    creditsToUseEl.oninput = ()=> recomputeBillingSplit(true);
  }
  if(billableHoursEl){
    billableHoursEl.oninput = ()=>{
      // If user types billable hours, compute credits remainder (only when credits ON)
      const useCredits = document.getElementById('billingUseCredits')?.value === "1";
      const billableOn = document.getElementById('billingMakeBillable')?.value === "1";
      if(!billableOn) return recomputeBillingSplit(true);

      const dur = durationHoursFloat();
      let b = clamp(parseFloat(billableHoursEl.value||"0"), 0, dur);
      billableHoursEl.value = to2(b);

      if(useCredits){
        const creditsEl = document.getElementById('creditsToUse');
        const creditsMax = Math.min(dur, CREDITS_REMAINING);
        const c = clamp(dur - b, 0, creditsMax);
        if(creditsEl) creditsEl.value = to2(c);
      }
      recomputeBillingSplit(true);
    };
  }
  if(hourlyRateEl){
    hourlyRateEl.oninput = ()=> recomputeBillingSplit(false);
  }


  // attachments init
  ATTACH_UPLOADS = [];
  renderAttachments();

  const attachInput = document.getElementById('attachInput');
  if(attachInput){
    attachInput.value = "";
    attachInput.onchange = (e)=> onFilesSelected(e.target.files);
  }
}

/* ---------- Submit Time Log ---------- */
function submitNewTimeLog(){
  const company = document.getElementById('addCompany').value;
  const project = document.getElementById('addProject').value;
  const task = document.getElementById('addTask').value;
  const user = document.getElementById('addUser').value || LOGGED_IN_USER;

  const hours = parseInt(document.getElementById('addHours').value || "0", 10);
  const minutes = parseInt(document.getElementById('addMinutes').value || "0", 10);
  const safeMinutes = Math.max(0, Math.min(59, minutes));
  const totalLabel = `${hours} hours, ${safeMinutes} minutes`;

  const comments = document.getElementById('addComments').value || "";
  const startDate = document.getElementById('addStartDate').value;

  const billingMode = document.getElementById('billingMode').value || "split";

  const hourlyRate = parseFloat(document.getElementById('addHourlyRate')?.value || "0");
  const discountPct = COMPANY_STANDARD_DISCOUNT_PCT;

  // NEW: split allocation
  const dur = durationHoursFloat();

  const useCredits = (document.getElementById('billingUseCredits')?.value === "1");
  const makeBillable = (document.getElementById('billingMakeBillable')?.value === "1");

  const creditsUsed = useCredits ? clamp(parseFloat(document.getElementById('creditsToUse')?.value || "0"), 0, Math.min(dur, CREDITS_REMAINING)) : 0;
  const billableHours = makeBillable ? clamp(parseFloat(document.getElementById('billableHours')?.value || "0"), 0, dur) : 0;

  // HARD VALIDATION: cannot exceed duration
  if((creditsUsed + billableHours) > (dur + 0.02)){
    alert(`Billing allocation cannot exceed duration. Duration: ${to2(dur)} hrs`);
    return;
  }

  // HARD VALIDATION: if billable ON, billable must be remainder
  if(makeBillable){
    const expectedBillable = Math.max(0, dur - creditsUsed);
    if(Math.abs(expectedBillable - billableHours) > 0.02){
      alert(`Billable hours must equal the remainder. Expected ${to2(expectedBillable)} hrs.`);
      return;
    }
  }

  const billable = makeBillable ? "Yes" : "No";

  const billableBeforeDiscount = billableHours * hourlyRate;
  const billableAfterDiscount = billableBeforeDiscount * (1 - (discountPct / 100));


  // Validation — keep minimal; task required
  if(!task){
    alert("Please choose a Task (or use Other Task).");
    return;
  }

  const newLog = {
    total: totalLabel,
    company: company || "—",
    project: project || "—",
    task,
    comments,
    user,
    id: "new_" + Math.random().toString(16).slice(2)
  };

  TIME_LOGS.unshift(newLog);

  renderList(document.getElementById('q').value || "");
  closeAddTimeLog();

  console.log("Submitted Time Log:", {
    company, project, task, user,
    startDate,
    hours, minutes: safeMinutes,
    billingMode, billable, hourlyRate,
    durationHours: dur,
    creditsRemaining: CREDITS_REMAINING,
    discountPct,
    creditsUsed: to2(creditsUsed),
    billableHours: to2(billableHours),
    billableBeforeDiscount: to2(billableBeforeDiscount),
    billableAfterDiscount: to2(billableAfterDiscount),

    attachments: ATTACH_UPLOADS.map(x=>({name:x.name, done:x.done, pct:x.pct})),
    comments
  });
}

/* ---------- Details (unchanged) ---------- */
function openDetails(idx){
  const x = TIME_LOGS[idx];
  if(!x) return;

  const companyId = "2790715";
  const createdAt = "01/08/2026 2:22 PM";
  const startTime = "12/22/2026 2:21 PM";
  const billable = (idx % 2 === 0) ? "Yes" : "No";
  const hourlyRate = 500;
  const hourlyAmount = "$50";
  const billableHours = "0.10 hrs";
  const billableAmount = "$50";
  const creditsUsed = "0.2 credits";

  document.getElementById('detailsBody').innerHTML = `
  <div class="companyCard">
    <div class="companyMeta">
      <div class="companyName">${x.company}</div>
      <div class="companySub">
        <span class="k">Company ID:</span> <span style="font-weight:500;color:#111">${companyId}</span>
      </div>
    </div>
    <div class="companyViewBtn" onclick="viewCompany('${escapeAttr(x.company)}','${companyId}')" title="View Company">View Company ↗︎</div>
  </div>

  <div class="actionRow">
    <div class="actionBtn" onclick="actionCall()" title="Call">
      <svg viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.8 19.8 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6A19.8 19.8 0 0 1 2.08 4.18 2 2 0 0 1 4.06 2h3a2 2 0 0 1 2 1.72c.12.86.31 1.7.57 2.5a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.58-1.09a2 2 0 0 1 2.11-.45c.8.26 1.64.45 2.5.57A2 2 0 0 1 22 16.92z"/></svg>
    </div>
    <div class="actionBtn" onclick="actionText()" title="Text">
      <svg viewBox="0 0 24 24"><path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"/></svg>
    </div>
    <div class="actionBtn" onclick="actionEmail()" title="Email">
      <svg viewBox="0 0 24 24"><path d="M4 4h16v16H4z"/><path d="M22 6l-10 7L2 6"/></svg>
    </div>
  </div>

  <div class="fieldCard">
    <div class="fieldTitle"><span class="dot"></span> Time Log Summary</div>
    <div class="kvGrid">
      <div class="kv">
        <div class="k">Total Time</div>
        <div class="v">${x.total}</div>
      </div>
      <div class="kv">
        <div class="k">Created At</div>
        <div class="v">${createdAt}</div>
      </div>
      <div class="kv">
        <div class="k">Start Time</div>
        <div class="v">${startTime}</div>
      </div>
      <div class="kv">
        <div class="k">Task</div>
        <div class="v">${x.task}</div>
      </div>
      <div class="kv">
        <div class="k">Project</div>
        <div class="v">${x.project}</div>
      </div>
      <div class="kv">
        <div class="k">Logged By</div>
        <div class="v">${x.user}</div>
      </div>
      <div class="kv">
        <div class="k">Time Log ID</div>
        <div class="v" style="color:#6b7280;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;font-size:12px">${x.id}</div>
      </div>
      <div class="kv">
        <div class="k">Comments</div>
        <div class="v" style="color:#5b6776">${escapeHtml(x.comments)}</div>
      </div>
    </div>
  </div>

  <div class="fieldCard">
    <div class="fieldTitle"><span class="dot"></span> Billing</div>
    <div class="kvGrid">
      <div class="kv"><div class="k">Billable</div><div class="v">${billable}</div></div>
      <div class="kv"><div class="k">Hourly Rate</div><div class="v">${billable === "Yes" ? `$${hourlyRate}/hr` : `<span class="mutedV">—</span>`}</div></div>
      <div class="kv"><div class="k">Hourly Amount</div><div class="v">${billable === "Yes" ? hourlyAmount : `<span class="mutedV">—</span>`}</div></div>
      <div class="kv"><div class="k">Billable Hours</div><div class="v">${billable === "Yes" ? billableHours : `<span class="mutedV">—</span>`}</div></div>
      <div class="kv"><div class="k">Billable Amount</div><div class="v">${billable === "Yes" ? billableAmount : `<span class="mutedV">—</span>`}</div></div>
      <div class="kv"><div class="k">Credits Used</div><div class="v">${billable === "Yes" ? creditsUsed : `<span class="mutedV">0 credits</span>`}</div></div>
    </div>
  </div>

  <!-- =========================
       NEW: Attachments (always visible + editable)
       ========================= -->
  <div class="fieldCard" id="detailsAttachmentsCard">
    <div class="fieldTitle"><span class="dot"></span> Attachments</div>

    <!-- Hidden input (details screen) -->
    <input id="detailsAttachInput" class="fileInputHidden" type="file" multiple />

    <div class="detailAttachStrip" onclick="openDetailsAttachmentPicker()">
      <div class="left">
        <div class="paperclip">
          <svg viewBox="0 0 24 24"><path d="M21 12.5l-8.5 8.5a5 5 0 0 1-7.07-7.07l9.2-9.2a3.5 3.5 0 0 1 4.95 4.95l-9.2 9.2a2 2 0 0 1-2.83-2.83l8.5-8.5"/></svg>
        </div>
        <div class="attachText">
          <div class="attachTitle">Add documents or screenshots</div>
          <div class="attachSub">Attachments are saved to this time log</div>
        </div>
      </div>
      <div class="userEditBtn" style="padding:8px 12px;">Add</div>
    </div>

    <!-- always shown: list can be empty -->
    <div class="detailAttachList" id="detailsAttachList"></div>
  </div>
`;

  // NEW: Always show attachments section (even if empty)
  loadDetailsAttachmentsFromLog(idx);

  navToDetails();

}



/* Init */
renderList();
renderViews();
</script>
</body>
</html>
